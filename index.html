<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - v3.7 (‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå 4 ‡∏£‡∏∞‡∏î‡∏±‡∏ö) - Full Width</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .marquee{position:relative;overflow:hidden;white-space:nowrap}
    .marquee span{position:relative;display:inline-block;will-change:transform;animation:scroll var(--scroll-duration,40s) linear infinite}
    @keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
    .slide-enter{animation:slideIn .35s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    #toggleTab{
      position: fixed; top: 50%; right: 10px; transform: translateY(-50%);
      z-index: 10020; width: 44px; height: 44px; border-radius: 9999px;
      background: #3b5cff; color: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.25);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; user-select: none; opacity: .9;
      transition: opacity .25s ease, transform .25s ease;
    }
    #toggleTab.is-hidden{ opacity:0; pointer-events:none; transform: translate(24px,-50%); }
    #toggleTab::before{ content: "‚Äπ"; font-weight: 700; }
    body.form-closed #toggleTab::before{ content: "‚Ä∫"; }

    #fullscreenBtn{
      position: fixed; top: 12px; right: 12px; z-index: 10020;
      background: rgba(0,0,0,.45); color:#fff; border-radius: 12px;
      padding: 8px 12px; box-shadow: 0 6px 16px rgba(0,0,0,.25); backdrop-filter: blur(6px);
      cursor: pointer; font-size: 14px;
    }

    @media (min-width: 1024px){
      .lg-grid-1{ grid-template-columns: repeat(1,minmax(0,1fr)) !important; }
      /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πá‡∏° */
      .lg-grid-10{ grid-template-columns: repeat(10,minmax(0,1fr)) !important; }
    }

    body { padding-bottom: 96px; }
    #announceBar{
      position: fixed; left:0; right:0; bottom:0; z-index: 10010;
      background: linear-gradient(90deg, #1e293b, #312e81 60%, #1e293b);
      color: #fff; box-shadow: 0 -8px 24px rgba(0,0,0,.25);
    }
    #announceBar .marquee{ mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
    #announceBar .marquee span{ font-size: clamp(18px, 3.2vw, 28px); padding-block: 12px; }
  </style>

<style>
:fullscreen body,
:-webkit-full-screen body {
  margin: 0;
}

:fullscreen #mainGrid,
:-webkit-full-screen #mainGrid {
  width: 100vw !important;
  max-width: 100vw !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

:fullscreen #slidesPanel,
:-webkit-full-screen #slidesPanel {
  width: 100vw !important;
  max-width: 100vw !important;
}

:fullscreen #slideContent > div,
:-webkit-full-screen #slideContent > div {
  width: 100vw !important;
  max-width: 100vw !important;
  border-radius: 0 !important;
}

:fullscreen .px-4,
:-webkit-full-screen .px-4 {
  padding-left: 0 !important;
  padding-right: 0 !important;
}
</style>


<style>
@keyframes softBlink {
  0%   { box-shadow: 0 0 0 0 rgba(255,0,0,0.4); }
  50%  { box-shadow: 0 0 25px 8px rgba(255,0,0,0.6); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0.4); }
}

.alert-blink {
  animation: softBlink 1.8s ease-in-out infinite;
}
</style>


<style>
@keyframes angryShake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(2px); }
  75% { transform: translateX(-2px); }
}
@keyframes angryBlink {
  0%   { box-shadow: 0 0 0 0 rgba(255,0,0,0.4); }
  50%  { box-shadow: 0 0 18px 6px rgba(255,0,0,0.7); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0.4); }
}
.emoji-angry {
  animation: angryShake 0.4s infinite, angryBlink 1.2s infinite;
}
.emoji-think {
  background: #fef9c3;
  border-radius: 8px;
  padding: 2px 6px;
}
.emoji-happy {
  background: #dcfce7;
  border-radius: 8px;
  padding: 2px 6px;
}
</style>


<style>

/* ===== PREMIUM BACKGROUND ANIMATION ===== */
@keyframes ultraGradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.ultra-bg {
  background: linear-gradient(-45deg,#0f172a,#1e293b,#1e1b4b,#0f172a);
  background-size: 400% 400%;
  animation: ultraGradient 25s ease infinite;
}

/* ===== GLASS EFFECT ===== */
.glass-panel {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.15);
}

/* ===== CARD HOVER 3D ===== */
.card-3d {
  transition: transform .4s ease, box-shadow .4s ease;
}
.card-3d:hover {
  transform: translateY(-6px) scale(1.04);
  box-shadow: 0 20px 40px rgba(0,0,0,.4);
}

/* ===== TOP RANK GLOW ===== */
@keyframes premiumGlow {
  0% { box-shadow: 0 0 15px rgba(255,0,0,.5); }
  50% { box-shadow: 0 0 45px rgba(255,0,0,.9); }
  100% { box-shadow: 0 0 15px rgba(255,0,0,.5); }
}

.top-premium {
  animation: premiumGlow 1.6s infinite;
}

/* ===== FADE ZOOM ===== */
@keyframes premiumFadeZoom {
  0% { opacity:0; transform:scale(.96); }
  100% { opacity:1; transform:scale(1); }
}

.slide-premium-animate {
  animation: premiumFadeZoom .7s ease;
}

</style>

</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 text-gray-800">
  <button id="fullscreenBtn" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (Shift+F)">‚õ∂ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
  <button id="toggleTab" title="‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Å‡∏î T)"></button>

  <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg">
    <div class="w-full px-4 py-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold">Internal Defect Control</h1>
        <p id="subtitle" class="opacity-90"></p>
      </div>
      <div class="flex items-center gap-4">
        <div id="recordCount" class="text-sm sm:text-base">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: 0 / 999</div>
        <div class="flex items-center gap-2">
          <button id="prevBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg">‚¨Ö ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <span id="slideCounter" class="min-w-[60px] text-center">0 / 0</span>
          <button id="nextBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°</button>
        </div>
      </div>
    </div>
  </header>

  <main id="mainGrid" class="w-full px-4 py-6 grid grid-cols-1 lg:grid-cols-[760px_minmax(0,1fr)] gap-6">
    <section id="formPanel">
      <div class="bg-white rounded-2xl shadow-xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
          <div class="flex gap-2">
            <button id="toggleFormBtn" class="text-sm text-indigo-600 hover:underline">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            <button id="openUpdatePanelBtn" class="text-sm text-emerald-600 hover:underline">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>
        </div>
        <form id="employeeForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</label>
            <input id="lineName" type="text" list="lineNameList" class="w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô Line A, ‡∏Å‡∏•‡∏∏‡πà‡∏° 1" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="employeeName" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station</label>
            <input id="employeeStation" type="text" class="w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô A1, S-3-1" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î NG</label>
            <input id="employeeCount" type="number" min="0" step="1" class="w-full border rounded-lg px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" required />
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</label>
            <input id="imageFile" type="file" accept="image/*" class="w-full" />
            <div id="imagePreview" class="hidden">
              <div class="flex items-center gap-3 bg-slate-50 border rounded-lg p-3">
                <img id="previewImg" alt="preview" class="w-16 h-16 object-cover rounded-full border">
                <div class="text-sm">
                  <div id="fileName" class="font-semibold"></div>
                  <button type="button" id="removeImage" class="text-red-600 hover:underline">‡πÄ‡∏≠‡∏≤‡∏£‡∏π‡∏õ‡∏≠‡∏≠‡∏Å</button>
                </div>
              </div>
            </div>
          </div>
          <button id="submitBtn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg py-2 font-semibold">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </form>

        <div id="updatePanel" class="mt-6 border-t pt-4 hidden">
          <h3 class="text-lg font-semibold mb-3">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</h3>

          <div class="flex flex-col gap-2 sm:flex-row sm:items-center mb-4">
            <input
              id="updateLineName"
              type="text"
              list="lineNameList"
              class="flex-1 border rounded-lg px-3 py-2"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï ‡πÄ‡∏ä‡πà‡∏ô Line A, ‡∏Å‡∏•‡∏∏‡πà‡∏° 1"
            />
            <button
              id="searchUpdateLineBtn"
              class="mt-2 sm:mt-0 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold"
              type="button"
            >
              ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
          </div>

          <div
            id="updateResult"
            class="bg-slate-50 border rounded-xl p-3 max-h-[520px] overflow-auto text-sm"
          >
            <p class="text-gray-500">
              ‚Ä¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
            </p>
          </div>

            <button
              id="saveUpdateLineBtn"
              type="button"
              class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-5 mt-6">
        <h2 class="text-xl font-bold mb-4">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</h2>
        <div class="flex items-center justify-between mb-3">
          <label class="flex items-center gap-2">
            <input id="autoSlideForm" type="checkbox" class="w-5 h-5">
            <span>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
          </label>
          <input id="slideIntervalForm" type="number" class="border rounded-lg px-3 py-1 w-32" value="5000">
        </div>
        <p class="text-sm text-gray-500">* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô 5000 = 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-5 mt-6">
        <h2 class="text-xl font-bold mb-3">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
        <textarea id="announcementText" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏î ‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ ,"></textarea>
        <button id="updateAnnouncementBtn" class="mt-3 w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg py-2 font-semibold">
          ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
        </button>
      </div>
    </section>

    <section id="slidesPanel">
      <div class="bg-white rounded-2xl shadow-xl p-5">
        <div id="slideContent" class="min-h[420px] min-h-[420px] flex items-center justify-center text-gray-400">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
      </div>
    </section>
  </main>

  <footer id="announceBar">
    <div class="w-full px-4">
      <div class="marquee">
        <span id="scrollingText" class="font-semibold tracking-wide select-none">üì¢ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
      </div>
    </div>
  </footer>

  <div id="liveRegion" class="sr-only" aria-live="polite"></div>

<script>
/* =====================
   ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ & ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
   ===================== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbw8zZUIvfxMWBm0nBaos8AXpQ2pBXKihxOls8uN2_gmqSY3QbawuvwWF9loKH8znWncgg/exec";

/** ‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ override ‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ?refresh=10000 */
const DEFAULT_SILENT_REFRESH_MS = Number(new URL(location.href).searchParams.get("refresh")) || 15000;

/** ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backoff ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå */
const BACKOFF_STEPS = [15000, 30000, 60000, 120000]; // 15s ‚Üí 2m

/* =====================
   Utilities
   ===================== */
function toEmbeddableDriveUrl(url){
  if(!url) return "";
  const m = url.match(/\/d\/([A-Za-z0-9_-]{10,})/) || url.match(/[?&]id=([A-Za-z0-9_-]{10,})/);
  if(!m) return url;
  const id = m[1];
  return `https://drive.google.com/thumbnail?id=${id}&sz=w256`;
}

function escapeHtml(text){ const d=document.createElement("div"); d.textContent=String(text??""); return d.innerHTML; }

// ==================================================================
// üí° MODIFIED: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå)
// ==================================================================
function getRelativeBorderColorClass(employeeCount, maxCount) {
    if (maxCount === 0 || employeeCount === 0) {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
        return 'border-2 border-indigo-200'; 
    }
    
    const percentage = (employeeCount / maxCount) * 100;
    
    // Gradient: Red (Highest) -> Orange (High) -> Yellow (Medium) -> Green (Low)
    if (percentage >= 80) {
        // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (>=80% ‡∏Ç‡∏≠‡∏á Max): ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°, ‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤ 4px ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô
        return 'border-4 border-red-700 ring-4 ring-red-300 shadow-xl'; 
    } else if (percentage >= 50) {
        // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á (50% - 79% ‡∏Ç‡∏≠‡∏á Max): ‡∏™‡∏µ‡∏™‡πâ‡∏°, ‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤ 2px
        return 'border-2 border-orange-500 shadow-lg';
    } else if (percentage >= 20) {
        // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏•‡∏≤‡∏á (20% - 49% ‡∏Ç‡∏≠‡∏á Max): ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á, ‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤ 2px
        return 'border-2 border-yellow-400'; 
    } else {
        // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡πà‡∏≥ (<20% ‡∏Ç‡∏≠‡∏á Max): ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô, ‡∏Ç‡∏≠‡∏ö‡∏´‡∏ô‡∏≤ 2px
        return 'border-2 border-green-300';
    }
}
// ==================================================================

let allEmployees = [];              // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let currentSlideIndex = 0;          // index ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå)
let autoSlideTimer = null;          // ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå
let selectedImageData = null;       // ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
let lastSnapshotSig = null;         // ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
let silentTimer = null;             // interval ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
let pollingLock = false;            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
let backoffIndex = 0;               // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ backoff
let updateLineEmployees = [];      // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
let currentUpdateLineName = "";    // ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î


/* =====================
   ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Google Apps Script (GET / POST)
   ===================== */
async function apiGET(params={}){
  const url = new URL(GAS_URL);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  url.searchParams.set("_", Date.now()); // bust cache
  const res = await fetch(url.toString(), { method:"GET" });
  if(!res.ok) throw new Error("API GET failed");
  return res.json();
}
async function apiPOST(body={}){
  const form = new URLSearchParams();
  Object.entries(body).forEach(([k,v])=>form.append(k, typeof v==="string"? v : String(v)));
  const res = await fetch(GAS_URL, { method:"POST", headers:{ "Content-Type":"application/x-wWW-form-urlencoded;charset=UTF-8" }, body: form.toString() });
  if(!res.ok) throw new Error("API POST failed");
  return res.json();
}

/* =====================
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
   ===================== */
async function loadInitialData(){
  try{
    const [listResp, cfgResp] = await Promise.all([ apiGET({action:"list"}), apiGET({action:"config"}) ]);
    if(listResp.ok && Array.isArray(listResp.employees)) allEmployees = normalizeEmployees(listResp.employees);
    if(cfgResp.ok && typeof cfgResp.announcement==="string") updateAnnouncementText(cfgResp.announcement);
    onDataChanged();                         // render ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    startSilentRefreshLoop();               // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
  }catch(e){ console.error(e); showMessage("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","error"); }
}

/* =====================
   Normalizers & Sorters
   ===================== */
function normalizeEmployees(list){ 
  return list.slice().map(x=>({ 
    line_name: String(x.line_name || ""), 
    image_url: toEmbeddableDriveUrl(String(x.image_url || "")), 
    employee_name: String(x.employee_name || ""), 
    employee_station: String(x.employee_station || ""),
    employee_count: Number(x.employee_count || 0),
    week1: Number(x.week1 || 0),
    week2: Number(x.week2 || 0),
    week3: Number(x.week3 || 0),
    week4: Number(x.week4 || 0)
  })); 
}
function getLineGroups(){ 
  const groups={}; 
  allEmployees.forEach(e=>{ 
    if(!groups[e.line_name]) groups[e.line_name]={lineName:e.line_name, employees:[]}; 
    groups[e.line_name].employees.push(e);
  }); 
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
  Object.values(groups).forEach(g=>g.employees.sort((a,b)=>b.employee_count-a.employee_count)); 
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏•‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ (Line Name)
  return Object.values(groups).sort((a,b)=>a.lineName.localeCompare(b.lineName,"th")); 
}
function stableSignature(emp, announcement){
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
  const clone = emp.slice().map(e=>({
    l: e.line_name, n: e.employee_name, s: e.employee_station||"",
    c: Number(e.employee_count||0), u: e.image_url||""
  }));
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
  clone.sort((a,b)=> (a.l.localeCompare(b.l,"th")|| a.n.localeCompare(b.n,"th") || a.s.localeCompare(b.s,"th") || b.c-a.c || a.u.localeCompare(b.u)));
  const head = JSON.stringify(clone);
  return head + "||" + String(announcement||"");
}

/* =====================
   ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå & UI
   ===================== */
function onDataChanged(){
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
  allEmployees = allEmployees.slice().sort((a,b)=> 
    a.line_name!==b.line_name ? a.line_name.localeCompare(b.line_name,"th") : b.employee_count-a.employee_count 
  );
  updateRecordCount();
  const lineGroups=getLineGroups();
  if(lineGroups.length>0){ 
    if(currentSlideIndex>=lineGroups.length) currentSlideIndex=0; 
    displaySlide(currentSlideIndex); 
  } else { 
    displayEmptyState(); 
  }
}

// =========================================================================================
// üí° MODIFIED: displaySlide FUNCTION
// =========================================================================================

function getAlertLevelBadge(employeeCount, maxCount){
  if(maxCount === 0) return "";
  const percentage = (employeeCount / maxCount) * 100;

  if(percentage >= 80){
    return `<div class="text-[11px] mt-1 bg-red-700 text-white px-3 py-1 rounded-full shadow-lg animate-pulse font-semibold">
    üö® ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô
    </div>`;
  }else if(percentage >= 50){
    return `<div class="text-[11px] mt-1 bg-orange-500 text-white px-3 py-1 rounded-full shadow-md font-semibold">
    üìå ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
    </div>`;
  }else{
    return `<div class="text-[11px] mt-1 bg-green-600 text-white px-3 py-1 rounded-full shadow-md font-semibold">
    ‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå
    </div>`;
  }
}

function displaySlide(index, opts={silent:false}){
  const lineGroups=getLineGroups(); 
  const currentLine=lineGroups[index]; 
  const slideContent=document.getElementById("slideContent"); 
  if(!currentLine){ displayEmptyState(); return; }

  const sorted=currentLine.employees.slice(); 
  const animateClass = opts.silent ? "" : "slide-enter";
  const numDisplayed = sorted.length; 
  const maxCols = 10;
  
  // üí° NEW: ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏µ
  const maxCount = sorted.reduce((max, employee) => Math.max(max, employee.employee_count), 0);
  
  slideContent.innerHTML = `
    <div class="ultra-bg glass-panel rounded-2xl shadow-2xl p-6 slide-premium-animate">
      <div class="text-center mb-6">
        <h2 class="text-4xl font-bold text-indigo-700 mb-4">${escapeHtml(currentLine.lineName)}</h2>
        <div class="inline-block bg-indigo-100 text-indigo-800 px-6 py-3 rounded-full font-semibold text-lg">
          ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î Internal Defect Control
        </div>
        <div class="mt-3 text-sm text-gray-600">
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå: ${currentLine.employees.length} ‡∏Ñ‡∏ô | ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ${numDisplayed} ‡∏Ñ‡∏ô
          ${maxCount > 0 ? `<span class="font-semibold text-red-600">(‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå: ${maxCount} ‡∏Ñ‡∏ô)</span>` : ''}
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-10 xl:grid-cols-10 gap-3">
        ${sorted.map((employee, idx)=>{
          const displayPosition = idx + 1;
          const src = escapeHtml(toEmbeddableDriveUrl(employee.image_url)) + '&t=' + Date.now();
          const employeeStation = escapeHtml(employee.employee_station || "-");
          
          // üí° MODIFIED: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (maxCount)
          
          const borderClasses = getRelativeBorderColorClass(employee.employee_count, maxCount);
          const isTop = (maxCount > 0 && employee.employee_count === maxCount);
          const alertClass = isTop ? " alert-blink" : "";

          let emoji = "";
          let emojiClass = "";

          if (idx === 0 && employee.employee_count > 0) {
            emoji = "üò°";
            emojiClass = "emoji-angry";
          } else if (idx === 1 && employee.employee_count > 0) {
            emoji = "ü§î";
            emojiClass = "emoji-think";
          } else {
            emoji = "üòä";
            emojiClass = "emoji-happy";
          }



          return `
              <div class="bg-gradient-to-b from-blue-50 to-indigo-50 rounded-lg p-3 ${borderClasses} shadow-md transition-all duration-300 card-3d${alertClass}">
                <div class="text-center mb-2">
                  <div class="bg-indigo-600 text-white w-7 h-7 rounded-full flex items-center justify-center mx-auto mb-1 font-bold text-sm">${displayPosition}</div>
                  <div class="text-lg mt-1 ${emojiClass}">${emoji}</div>
${idx === 0 ? `<div class="text-[10px] mt-1 bg-red-600 text-white px-2 py-0.5 rounded-full animate-pulse">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>` : ""}

                  <div class="text-xs text-gray-500">‡∏•‡∏≥‡∏î‡∏±‡∏ö ${displayPosition} (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${employee.employee_count})</div>
                </div>
                <div class="flex justify-center mb-2">
                  <div class="relative w-16 h-16">
                    <img src="${src}" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${escapeHtml(employee.employee_name)}"
                         referrerpolicy="no-referrer" decoding="async"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         class="w-16 h-16 object-cover rounded-full border-2 border-indigo-400 shadow-md" loading="lazy"/>
                    <div style="display:none;" class="w-16 h-16 bg-gradient-to-br from-red-100 to-orange-100 rounded-full border-2 border-red-300 flex items-center justify-center">
                      <span class="text-xs text-red-600 font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ</span>
                    </div>
                  </div>
                </div>
                <div class="text-center space-y-1">
                  <div class="bg-white rounded-lg p-2">
                    <p class="text-xs text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</p>
                    <p class="text-xs font-bold text-gray-800 leading-tight">${escapeHtml(employee.employee_name)}</p>
                  </div>
                  <div class="bg-yellow-100 rounded-lg p-2">
                    <p class="text-xs text-gray-600 mb-1">Station</p>
                    <p class="text-sm font-bold text-yellow-600">${employeeStation}</p>
                  </div>
                  <div class="bg-blue-100 rounded-lg p-2">
                    <p class="text-xs text-gray-600 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°</p>
                    <p class="text-sm font-bold text-blue-600">${employee.employee_count}</p>
                  </div>

                  <div class="bg-white rounded-lg p-2 border">
                    <p class="text-xs text-gray-500 mb-1">Week1 - Week4</p>
                    <div class="grid grid-cols-2 gap-1 text-xs font-semibold text-gray-700">
                      <div>W1: ${employee.week1}</div>
                      <div>W2: ${employee.week2}</div>
                      <div>W3: ${employee.week3}</div>
                      <div>W4: ${employee.week4}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          }).join("")}
          
        ${Array(Math.max(0, maxCols - sorted.length)).fill(0).map((_, displayPositionOffset) => {
          const displayPosition = sorted.length + displayPositionOffset + 1;
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10
          if (sorted.length >= maxCols) return ''; 
          return `
              <div class="bg-gray-100 rounded-lg p-3 border-2 border-gray-200 shadow-md opacity-50">
                <div class="text-center mb-2">
                  <div class="bg-gray-400 text-white w-7 h-7 rounded-full flex items-center justify-center mx-auto mb-1 font-bold text-sm">${displayPosition}</div>
                  <div class="text-lg mt-1 ${emojiClass}">${emoji}</div>
${idx === 0 ? `<div class="text-[10px] mt-1 bg-red-600 text-white px-2 py-0.5 rounded-full animate-pulse">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>` : ""}

                </div>
                <div class="flex justify-center mb-2">
                  <div class="w-16 h-16 bg-gray-200 rounded-full border-2 border-gray-300 flex items-center justify-center">
                    <span class="text-xl text-gray-400">üë§</span>
                  </div>
                </div>
                <div class="text-center space-y-1">
                  <div class="bg-white rounded-lg p-2">
                    <p class="text-xs text-gray-400 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</p>
                    <p class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                  </div>
                  <div class="bg-gray-200 rounded-lg p-2">
                    <p class="text-xs text-gray-400 mb-1">‡∏™‡πÄ‡∏ï‡∏ä‡∏±‡πà‡∏ô</p>
                    <p class="text-sm text-gray-400">-</p>
                  </div>
                  <div class="bg-gray-200 rounded-lg p-2">
                    <p class="text-xs text-gray-400 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
                    <p class="text-sm text-gray-400">-</p>
                  </div>
                </div>
              </div>`;
          }).join("")}
      </div>
    </div>`;
  updateSlideCounter();
}
// =========================================================================================
// üí° END MODIFIED
// =========================================================================================

function displayEmptyState(){ 
  document.getElementById("slideContent").innerHTML='<div class="text-center text-gray-400"><p class="text-2xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p><p class="text-lg mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</p></div>'; 
  updateSlideCounter(); 
}
function updateSlideCounter(){ 
  const counter=document.getElementById("slideCounter"); 
  const lineGroups=getLineGroups(); 
  counter.textContent= lineGroups.length>0 ? `${currentSlideIndex+1} / ${lineGroups.length}` : "0 / 0"; 
}
function updateRecordCount(){ 
  const el=document.getElementById("recordCount"); 
  el.textContent=`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${allEmployees.length} / 999`; 
  el.classList.toggle("text-red-600", allEmployees.length>=999); 
  el.classList.toggle("font-bold", allEmployees.length>=999); 
}
function updateAnnouncementText(newText){ 
  const el=document.getElementById("scrollingText"); 
  const parts=String(newText||"").split(/‚Ä¢|,/).map(s=>s.trim()).filter(Boolean); 
  const display=parts.length?parts.join(" ‚Ä¢ "):String(newText||""); 
  el.textContent=`üì¢ ${display} `; 
  // ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
  el.style.animation="none"; void el.offsetHeight; 
  el.style.animation="scroll var(--scroll-duration, 40s) linear infinite"; 
}
function showMessage(message,type){ 
  const div=document.createElement("div"); 
  let bg="bg-red-500"; 
  if(type==="success") bg="bg-green-500"; else if(type==="info") bg="bg-blue-500"; 
  div.className=`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold ${bg}`; 
  div.textContent=message; document.body.appendChild(div); setTimeout(()=>div.remove(),2500); 
}

/* =====================
   ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå
   ===================== */
function startAutoSlide(){
  stopAutoSlide();
  const ms = parseInt(document.getElementById("slideIntervalForm").value,10);
  if(!Number.isFinite(ms) || ms <= 0) return;
  autoSlideTimer = setInterval(()=>{
    const g = getLineGroups();
    if (g.length === 0) return;
    currentSlideIndex = (currentSlideIndex + 1) % g.length;
    displaySlide(currentSlideIndex); // ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô
  }, ms);
}
function stopAutoSlide(){
  if(autoSlideTimer){ clearInterval(autoSlideTimer); autoSlideTimer = null; }
}

/* =====================
   Silent Refresh (Auto Reset / Background Update)
   ===================== */
async function pollOnceSilently(){
  if(pollingLock) return;
  pollingLock = true;
  try{
    const [listResp, cfgResp] = await Promise.all([ apiGET({action:"list"}), apiGET({action:"config"}) ]);
    const latestEmployees = listResp.ok && Array.isArray(listResp.employees) ? normalizeEmployees(listResp.employees) : allEmployees.slice();
    const latestAnnouncement = (cfgResp.ok && typeof cfgResp.announcement==="string") ? cfgResp.announcement : undefined;

    const nextSig = stableSignature(latestEmployees, latestAnnouncement ?? document.getElementById("scrollingText").textContent);
    if(nextSig !== lastSnapshotSig){
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πÑ‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏î‡∏π‡∏™‡∏∞‡∏î‡∏∏‡∏î
      const groupsBefore = getLineGroups();
      const currentLineName = groupsBefore[currentSlideIndex]?.lineName ?? null;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
      allEmployees = latestEmployees.slice();
      if(typeof latestAnnouncement === "string") updateAnnouncementText(latestAnnouncement);
      updateRecordCount();

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡∏á‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏î‡∏¥‡∏°
      const groupsAfter = getLineGroups();
      if(groupsAfter.length === 0){
        displayEmptyState();
      }else{
        // ‡∏´‡∏≤ index ‡∏Ç‡∏≠‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏° ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á index ‡∏ô‡∏±‡πâ‡∏ô
        let targetIndex = 0;
        if(currentLineName){
          const found = groupsAfter.findIndex(g => g.lineName === currentLineName);
          targetIndex = found >= 0 ? found : Math.min(currentSlideIndex, groupsAfter.length-1);
        }else{
          targetIndex = Math.min(currentSlideIndex, groupsAfter.length-1);
        }
        currentSlideIndex = targetIndex;
        displaySlide(currentSlideIndex, {silent:true}); // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô
      }

      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏™‡∏≤‡∏¢‡∏ï‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
      const live = document.getElementById("liveRegion");
      if(live){ live.textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß"; }

      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï backoff ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      backoffIndex = 0;
      lastSnapshotSig = nextSig;
    }
  }catch(err){
    console.error("Silent refresh failed:", err);
    // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á polling ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (backoff)
    backoffIndex = Math.min(backoffIndex+1, BACKOFF_STEPS.length-1);
    restartSilentTimer(BACKOFF_STEPS[backoffIndex]);
  }finally{
    pollingLock = false;
  }
}
function startSilentRefreshLoop(){
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
  lastSnapshotSig = null;
  restartSilentTimer(DEFAULT_SILENT_REFRESH_MS);
}
function restartSilentTimer(ms){
  if(silentTimer) clearInterval(silentTimer);
  silentTimer = setInterval(pollOnceSilently, ms);
}
/* ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢: ‡∏´‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‡∏ô‡∏≤‡∏ô ‡πÜ ‡∏≠‡∏≤‡∏à‡∏ú‡πà‡∏≠‡∏ô polling ‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
   ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î) */
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden){
    restartSilentTimer(Math.max(DEFAULT_SILENT_REFRESH_MS, 25000));
  }else{
    restartSilentTimer(DEFAULT_SILENT_REFRESH_MS);
  }
});

/* =====================
   ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ï‡πà‡∏≤‡∏á ‡πÜ
   ===================== */

/* =====================
   ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï
   ===================== */
function renderUpdateTable() {
  const container = document.getElementById("updateResult");
  const saveBtn = document.getElementById("saveUpdateLineBtn");

  if (!container) return;

  if (!updateLineEmployees || updateLineEmployees.length === 0) {
    container.innerHTML = `
      <p class="text-red-500 font-semibold">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏•‡∏ô‡πå <span class="underline">${escapeHtml(currentUpdateLineName || "")}</span>
      </p>
      <p class="text-gray-500 text-xs mt-1">
        * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </p>
    `;
    if (saveBtn) saveBtn.disabled = true;
    return;
  }

  
  const rowsHtml = updateLineEmployees
    .map((emp, idx) => {
      const safeName = escapeHtml(emp.employee_name);
      const safeStation = escapeHtml(emp.employee_station || "");
      const w1 = Number(emp.week1 || 0);
      const w2 = Number(emp.week2 || 0);
      const w3 = Number(emp.week3 || 0);
      const w4 = Number(emp.week4 || 0);
      const total = w1 + w2 + w3 + w4;
      const imgSrc = emp.previewImageData || emp.image_url || "";

      return `
        <tr class="border-b last:border-0">
          <td class="p-2 text-xs text-center">${idx + 1}</td>
          <td class="p-2">
            <div class="flex flex-col gap-2">
              <input class="border rounded px-2 py-1 text-xs"
                data-idx="${idx}" data-field="employee_name"
                value="${safeName}" />
              <input class="border rounded px-2 py-1 text-xs"
                data-idx="${idx}" data-field="employee_station"
                value="${safeStation}" />

              <div class="flex gap-2">
                <input type="number" min="0" class="border rounded px-2 py-1 w-20 text-right"
                  data-idx="${idx}" data-field="week1" value="${w1}" />
                <input type="number" min="0" class="border rounded px-2 py-1 w-20 text-right"
                  data-idx="${idx}" data-field="week2" value="${w2}" />
                <input type="number" min="0" class="border rounded px-2 py-1 w-20 text-right"
                  data-idx="${idx}" data-field="week3" value="${w3}" />
                <input type="number" min="0" class="border rounded px-2 py-1 w-20 text-right"
                  data-idx="${idx}" data-field="week4" value="${w4}" />

                <div class="bg-gray-100 font-bold border rounded px-2 py-1 w-20 text-right">
                  ${total}
                </div>
              </div>
            </div>
          </td>
          <td class="p-2">
            <div class="flex flex-col gap-2">

              <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-200 flex items-center justify-center text-xs">
                ${imgSrc 
                  ? `<img src="${escapeHtml(imgSrc)}" class="w-12 h-12 object-cover" />`
                  : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ"}
              </div>

              <label class="text-[11px] font-medium text-gray-600">
                ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)
              </label>

              <input 
                type="file"
                accept="image/*"
                data-idx="${idx}"
                data-field="image_file"
                class="text-[11px] border rounded px-1 py-1 bg-white"
              />

            </div>
          </td>
        </tr>
      `;
    })
    .join("");


  container.innerHTML = `
    <p class="mb-2 text-gray-700 text-sm">
      ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏•‡∏ô‡πå:
      <span class="font-semibold text-indigo-600">${escapeHtml(currentUpdateLineName)}</span>
    </p>
    <div class="overflow-auto">
      <table class="w-full border text-xs bg-white">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-2 w-10 text-center">#</th>
            <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡∏™‡πÄ‡∏ï‡∏ä‡∏±‡πà‡∏ô / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="p-2 w-64">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
    <p class="mt-2 text-[11px] text-gray-500">
      * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    </p>
  `;

  if (saveBtn) saveBtn.disabled = false;
}

function searchEmployeesByLine(lineName) {
  const trimmed = String(lineName || "").trim();
  currentUpdateLineName = trimmed;

  if (!trimmed) {
    updateLineEmployees = [];
    renderUpdateTable();
    return;
  }

  updateLineEmployees = allEmployees
    .filter(e => String(e.line_name).trim() === trimmed)
    .map(e => ({
      ...e,
      previewImageData: e.image_url || "",
      newImageData: "",
    }));

  renderUpdateTable();
}

async function saveUpdateLineToServer() {
  if (!currentUpdateLineName || updateLineEmployees.length === 0) {
    showMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "error");
    return;
  }

  const saveBtn = document.getElementById("saveUpdateLineBtn");
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
  }

  try {
    const payloadEmployees = updateLineEmployees.map(emp => ({
      line_name: currentUpdateLineName,
      employee_name: String(emp.employee_name || ""),
      employee_station: String(emp.employee_station || ""),
      employee_count: Number(emp.employee_count || 0),
      week1: Number(emp.week1 || 0),
      week2: Number(emp.week2 || 0),
      week3: Number(emp.week3 || 0),
      week4: Number(emp.week4 || 0),
      imageData: emp.newImageData || "",
      imageUrl: emp.image_url || "",
    }));

    const resp = await apiPOST({
      action: "update_line",
      lineName: currentUpdateLineName,
      employees: JSON.stringify(payloadEmployees),
    });

    if (!resp.ok) {
      throw new Error(resp.error || "update_line failed");
    }

    if (Array.isArray(resp.employees)) {
      allEmployees = normalizeEmployees(resp.employees);
    } else {
      const others = allEmployees.filter(
        e => String(e.line_name).trim() !== currentUpdateLineName
      );
      const updated = payloadEmployees.map(e => ({
        line_name: e.line_name,
        employee_name: e.employee_name,
        employee_station: e.employee_station,
        employee_count: e.employee_count,
        image_url: toEmbeddableDriveUrl(e.imageUrl || ""),
      }));
      allEmployees = others.concat(updated);
    }

    onDataChanged();
    searchEmployeesByLine(currentUpdateLineName);

    showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");

    lastSnapshotSig = stableSignature(
      allEmployees,
      document.getElementById("scrollingText").textContent
    );
  } catch (err) {
    console.error(err);
    showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", "error");
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    }
  }
}

function setupEventListeners(){
  document.getElementById("toggleFormBtn").addEventListener("click", toggleFormPanel);
  document.getElementById("toggleTab").addEventListener("click", toggleFormPanel);

  document.getElementById("employeeForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const lineName = document.getElementById("lineName").value.trim();
    const employeeName = document.getElementById("employeeName").value.trim();
    const employeeStation = document.getElementById("employeeStation").value.trim();
    const rawCount = document.getElementById("employeeCount").value;
    const employeeCount = Number.parseInt(rawCount,10);
    if(!lineName||!employeeName||Number.isNaN(employeeCount)){ showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","error"); return; }
    const submitBtn=document.getElementById("submitBtn"); submitBtn.disabled=true; submitBtn.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
    try{
      const resp = await apiPOST({ action:"create", lineName, employeeName, employeeStation, employeeCount:Math.max(0,employeeCount), imageData:selectedImageData||"", imageUrl:"" });
      if(!resp.ok) throw new Error(resp.error||"create failed");
      const created = resp.created || { line_name:lineName, image_url:"", employee_name:employeeName, employee_station:employeeStation, employee_count:Math.max(0,employeeCount) };
      allEmployees.push({ line_name:created.line_name, image_url:toEmbeddableDriveUrl(created.image_url||""), employee_name:created.employee_name, employee_station:created.employee_station, employee_count:created.employee_count });
      onDataChanged();
      document.getElementById("employeeForm").reset(); selectedImageData=null; document.getElementById("imagePreview").classList.add("hidden");
      showMessage("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!","success");
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ render ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
      lastSnapshotSig = stableSignature(allEmployees, document.getElementById("scrollingText").textContent);
    }catch(err){ console.error(err); showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•","error"); }
    finally{ submitBtn.disabled=false; submitBtn.textContent="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; }
  });

  document.getElementById("imageFile").addEventListener("change",(e)=>{
    const file=e.target.files&&e.target.files[0];
    if(file){
      if(file.size>5*1024*1024){ showMessage("‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ","error"); e.target.value=""; return; }
      if(!file.type.startsWith("image/")){ showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô","error"); e.target.value=""; return; }
      const reader=new FileReader();
      reader.onload=(ev)=>{ selectedImageData=ev.target.result; document.getElementById("previewImg").src=selectedImageData; document.getElementById("fileName").textContent=file.name; document.getElementById("imagePreview").classList.remove("hidden"); };
      reader.readAsDataURL(file);
    }
  });
  document.getElementById("removeImage").addEventListener("click",()=>{
    const imageFile=document.getElementById("imageFile"); imageFile.value=""; selectedImageData=null; document.getElementById("imagePreview").classList.add("hidden"); document.getElementById("previewImg").src=""; document.getElementById("fileName").textContent="";
  });

  document.getElementById("autoSlideForm").addEventListener("change",(e)=>{
    if(e.target.checked){ startAutoSlide(); showMessage("‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥","success"); }
    else { stopAutoSlide(); showMessage("‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥","info"); }
  });
  document.getElementById("slideIntervalForm").addEventListener("change",()=>{
    if(document.getElementById("autoSlideForm").checked){ startAutoSlide(); }
  });

  document.getElementById("prevBtn").addEventListener("click", ()=>{
    const g=getLineGroups(); if(g.length>0){ currentSlideIndex=(currentSlideIndex-1+g.length)%g.length; displaySlide(currentSlideIndex); }
  });
  document.getElementById("nextBtn").addEventListener("click", ()=>{
    const g=getLineGroups(); if(g.length>0){ currentSlideIndex=(currentSlideIndex+1)%g.length; displaySlide(currentSlideIndex); }
  });

  document.getElementById("updateAnnouncementBtn").addEventListener("click", async ()=>{
    const newText = document.getElementById("announcementText").value.trim();
    if(!newText){ showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®","error"); return; }
    try{
      const resp = await apiPOST({ action:"update_announcement", announcement:newText });
      if(!resp.ok){ throw new Error(resp.error||'update announcement failed'); }
      updateAnnouncementText(resp.announcement || newText);
      document.getElementById("announcementText").value="";
      showMessage("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!","success");
      lastSnapshotSig = stableSignature(allEmployees, resp.announcement || newText);
    }catch(e){ console.error(e); showMessage("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","error"); }
  });

  document.addEventListener("keydown", (e) => {
    if ((e.key === "F" || e.key === "f") && e.shiftKey){ e.preventDefault(); toggleFullscreen(); }
    if (e.key === "t" || e.key === "T"){ e.preventDefault(); toggleFormPanel(); }
    if (e.key === "ArrowLeft") document.getElementById("prevBtn").click();
    if (e.key === "ArrowRight") document.getElementById("nextBtn").click();
  });

  /* ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï */
  const openUpdatePanelBtn = document.getElementById("openUpdatePanelBtn");
  const updatePanel = document.getElementById("updatePanel");
  if (openUpdatePanelBtn && updatePanel) {
    openUpdatePanelBtn.addEventListener("click", () => {
      updatePanel.classList.toggle("hidden");
    });
  }

  const searchUpdateLineBtn = document.getElementById("searchUpdateLineBtn");
  const updateLineNameInput = document.getElementById("updateLineName");
  if (searchUpdateLineBtn && updateLineNameInput) {
    searchUpdateLineBtn.addEventListener("click", () => {
      searchEmployeesByLine(updateLineNameInput.value);
    });

    updateLineNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchEmployeesByLine(updateLineNameInput.value);
      }
    });
  }

  const updateResult = document.getElementById("updateResult");
  if (updateResult) {
    updateResult.addEventListener("input", (e) => {
      const target = e.target;
      const idx = Number(target.getAttribute("data-idx"));
      const field = target.getAttribute("data-field");
      if (!Number.isFinite(idx) || !field) return;
      if (!updateLineEmployees[idx]) return;

      if (field === "employee_name") {
        updateLineEmployees[idx].employee_name = target.value;
      } else if (field === "employee_station") {
        updateLineEmployees[idx].employee_station = target.value;
      } else if (field === "week1" || field === "week2" || field === "week3" || field === "week4") {
        updateLineEmployees[idx][field] = Number(target.value || 0);
        const e = updateLineEmployees[idx];
        e.employee_count = (Number(e.week1||0) + Number(e.week2||0) + Number(e.week3||0) + Number(e.week4||0));
        renderUpdateTable();
      } else if (field === "employee_count") {
        updateLineEmployees[idx].employee_count = Number(target.value || 0);
      }
    });

    updateResult.addEventListener("change", (e) => {
      const target = e.target;
      if (target.type === "file" && target.getAttribute("data-field") === "image_file") {
        const idx = Number(target.getAttribute("data-idx"));
        if (!Number.isFinite(idx) || !updateLineEmployees[idx]) return;

        const file = target.files && target.files[0];
        if (!file) return;

        if (file.size > 5 * 1024 * 1024) {
          showMessage("‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏Å‡∏¥‡∏ô 5MB)", "error");
          target.value = "";
          return;
        }
        if (!file.type.startsWith("image/")) {
          showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "error");
          target.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = (ev) => {
          updateLineEmployees[idx].newImageData = ev.target.result;
          updateLineEmployees[idx].previewImageData = ev.target.result;
          renderUpdateTable();
        };
        reader.readAsDataURL(file);
      }
    });
  }

  const saveUpdateLineBtn = document.getElementById("saveUpdateLineBtn");
  if (saveUpdateLineBtn) {
    saveUpdateLineBtn.addEventListener("click", () => {
      saveUpdateLineToServer();
    });
  }

  setupAutoHideToggleTab();
}

/* =====================
   Fullscreen & Layout
   ===================== */
async function enterFullscreen(){ const el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen(); }
async function exitFullscreen(){ if(document.exitFullscreen) await document.exitFullscreen(); else if(document.webkitExitFullscreen) await document.webkitExitFullscreen(); }
async function toggleFullscreen(){ if(document.fullscreenElement||document.webkitFullscreenElement){ await exitFullscreen(); } else { await enterFullscreen(); } }
document.getElementById("fullscreenBtn").addEventListener("click", toggleFullscreen);

function toggleFormPanel(){
  const form = document.getElementById("formPanel");
  const mainGrid = document.getElementById("mainGrid");
  const slides = document.getElementById("slidesPanel");
  const isHidden = form.classList.contains("hidden");
  if(isHidden){
    document.body.classList.remove("form-closed");
    form.classList.remove("hidden");
    mainGrid.classList.remove("lg-grid-1");
    slides.classList.remove("lg:col-span-1");
    slides.classList.add("lg:col-span-2");
  } else {
    document.body.classList.add("form-closed");
    form.classList.add("hidden");
    mainGrid.classList.add("lg-grid-1");
    slides.classList.remove("lg:col-span-2");
    slides.classList.add("lg:col-span-1");
  }
}
document.getElementById("toggleFormBtn").addEventListener("click", toggleFormPanel);

function setupAutoHideToggleTab(){
  const AUTO_HIDE_MS = 20000;
  let hideTimer = null;
  const tab = document.getElementById("toggleTab");

  function showTab(){ tab.classList.remove("is-hidden"); }
  function hideTab(){ tab.classList.add("is-hidden"); }
  function resetTimer(){
    clearTimeout(hideTimer);
    showTab();
    hideTimer = setTimeout(()=>{
      const active = document.activeElement;
      const isTyping = active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA");
      if(!isTyping) hideTab();
    }, AUTO_HIDE_MS);
  }
  ["mousemove","mousedown","keydown","scroll","touchstart","pointermove","focusin","input","click"].forEach(evt =>
    window.addEventListener(evt, resetTimer, {passive:true})
  );
  document.addEventListener("fullscreenchange", resetTimer);
  document.addEventListener("webkitfullscreenchange", resetTimer);
  resetTimer();
}

/* =====================
   ‡∏ö‡∏π‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
   ===================== */
setupEventListeners();
loadInitialData();
</script>

    <datalist id="lineNameList">
      <option value="J30A FB-RH-A"></option>
      <option value="J30A FB-RH-B"></option>
      <option value="J30A FB-LH-A"></option>
      <option value="J30A FB-LH-B"></option>
      <option value="J30A FC-RH-A"></option>
      <option value="J30A FC-RH-B"></option>
      <option value="J30A FC-LH-A"></option>
      <option value="J30A FC-LH-B"></option>
      <option value="J30A RB-D"></option>
      <option value="J30A RC-D"></option>
      <option value="J30S RB-RH-D"></option>
      <option value="J30S RB-LH-D"></option>
      <option value="J30S RC-RH-D"></option>
      <option value="J30S RC-LH-D"></option>
      <option value="J69P FB-RH-B"></option>
      <option value="J69P FB-RH-A"></option>
      <option value="J69P FB-LH-A"></option>
      <option value="J69P FB-LH-B"></option>
      <option value="J69P FC-RH-A"></option>
      <option value="J69P FC-RH-B"></option>
      <option value="J69P FC-LH-A"></option>
      <option value="J69P FC-LH-B"></option>
      <option value="J69P RB-RH-A"></option>
      <option value="J69P RB-RH-B"></option>
      <option value="J69P RB-LH-A"></option>
      <option value="J69P RB-LH-B"></option>
      <option value="J69P RC-A"></option>
      <option value="J69P RC-B"></option>
    </datalist>
</body>
</html>
